<%= stylesheet_link_tag "markdown_editor" %>

<%= form_for(post) do |f| %>

<div id="post_title">
	<label for="title" id="post_title_label" class="post_form_label">
		title:
	</label>
	<span id="post_title_field">
		<%= f.text_field(:title, :size => 100) %>
	</span>  	
</div>
<div id="post_excerpt">
	<label for="excerpt" id="post_excerpt_label" class="post_form_label">
		summary:
	</label>
	<span id="post_excerpt_field">
		<%= f.text_field(:excerpt, :size => 100) %>
	</span>  	
</div>
<div id="post_body">
	<div class="wmd-panel" id="post_body_text">
	    <div id="wmd-button-bar"></div>
		<%= f.text_area(:body, :class => "wmd-input", :id => "wmd-input")%>
	</div> 
	preview:
	<div id="wmd-preview" class="wmd-panel wmd-preview"></div> 	
</div>
<span id="post_submit">
	<%= f.submit %>
</span>
<span>
	<%= link_to "cancel", :back %>
</span>
<div id="dialog" title="Dialog">
	<%= form_tag({:action => :upload}, :multipart => true, :id => "image_upload_form") do %>
	  <%= file_field_tag 'image' %>
	  <%= submit_tag("Upload Image", :id => 'upload_btn') %>
	<% end %>	
</div>
<% end %>

<script type="text/javascript">
    (function () {
        var converter1 = new Markdown.Converter();
        var editor = new Markdown.Editor(converter1);

		editor.hooks.set("insertImageDialog", function (callback) {
			$(document).ready(function(){
			    $("#dialog").dialog();
				$("#upload_btn").click(function(){
					var formData = new FormData();
					formData.append('image', $('#image')[0].files[0])
				    $.ajax({
				        url: '/image/upload',  //server script to process data
				        type: 'POST',
				        success: function(responseText,b,c){
							callback(responseText);
						},
				        error: function(responseText, b,c){
							callback(null);
						},
				        // Form data
				        data: formData,
				        //Options to tell JQuery not to process data or worry about content-type
				        cache: false,
				        contentType: false,
				        processData: false
				    });
				    
				})
			});
			
			return true;
		});
		
        editor.run();
	})();
	
	function progressHandlingFunction(e){
	    if(e.lengthComputable){
	        $('progress').attr({value:e.loaded,max:e.total});
	    }
	}
	
</script>